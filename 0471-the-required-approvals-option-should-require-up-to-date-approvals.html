<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>0471 — The required_approvals option should require up-to-date approvals - The Bors RFC Archive</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../index.html">Introduction</a></li><li class="chapter-item expanded "><a href="INFORMATIONAL.html">Informational RFC</a></li><li class="chapter-item expanded "><a href="PROCESS.html">Process RFC</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="0296-adopt-a-process-for-proposing-approving-and-tracking-major-changes-to-bors-ng.html">0296 — Adopt a process for proposing, approving, and tracking major changes to bors-ng</a></li><li class="chapter-item expanded "><a href="0332-elixir-and-erlang-version-update-policy.html">0332 — Elixir and Erlang version update policy</a></li><li class="chapter-item expanded "><a href="0412-simplify-bors-ng-bors-ngs-label-system.html">0412 — Simplify bors-ng/bors-ng's label system</a></li><li class="chapter-item expanded "><a href="0434-show-status-on-accepted-rfcs.html">0434 — Show status on accepted RFCs</a></li></ol></li><li class="chapter-item expanded "><a href="FEATURE.html">Feature RFC</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="0313-the-bors-button-extension.html">0313 — The bors button extension</a></li><li class="chapter-item expanded "><a href="0322-pre-test-and-pre-merge-hooks.html">0322 — Pre-test and Pre-merge hooks</a></li><li class="chapter-item expanded "><a href="0347-ability-to-create-merge-commits-locally-in-self-hosted-instances-of-bors.html">0347 — Ability to create merge commits locally in self-hosted instances of Bors</a></li><li class="chapter-item expanded "><a href="0349-use-a-squash-merge-in-bors.html">0349 — Use a squash merge in Bors</a></li><li class="chapter-item expanded "><a href="0357-bors-support-for-codeowners.html">0357 — Bors support for CODEOWNERS</a></li><li class="chapter-item expanded "><a href="0360-add-a-new-configuration-option-status-wait-success.html">0360 — Add a new configuration option status_wait_success</a></li><li class="chapter-item expanded "><a href="0362-allow-delegate-to-be-abbreviated-as-d.html">0362 — Allow delegate to be abbreviated as d</a></li><li class="chapter-item expanded "><a href="0376-allow-merge-as-an-alias-for-r.html">0376 — Allow merge as an alias for r+</a></li><li class="chapter-item expanded "><a href="0388-wait-for-ci-to-finish-instead-of-rejecting-immediately-on-bors-r-when-ci-is-still-pending.html">0388 — Wait for CI to finish instead of rejecting immediately on bors r+ when CI is still &quot;pending&quot;</a></li><li class="chapter-item expanded "><a href="0425-allow-patches-to-be-batched-by-themselves-only.html">0425 — Allow patches to be batched by themselves only</a></li><li class="chapter-item expanded "><a href="0471-the-required-approvals-option-should-require-up-to-date-approvals.html" class="active">0471 — The required_approvals option should require up-to-date approvals</a></li><li class="chapter-item expanded "><a href="0507-update-base-branch-of-prs-depending-on-a-branch-that-will-be-deleted.html">0507 — Update base branch of PRs depending on a branch that will be deleted</a></li><li class="chapter-item expanded "><a href="0508-log-outgoing-http-request.html">0508 — Log outgoing HTTP request</a></li><li class="chapter-item expanded "><a href="0521-add-a-new-environment-variable-public-protocol-to-allow-serving-bors-at-a-http-endpoint.html">0521 — Add a new environment variable 'PUBLIC_PROTOCOL', to allow serving bors at a HTTP endpoint</a></li><li class="chapter-item expanded "><a href="0516-add-support-for-custom-commit-titles.html">0516 — Add support for custom commit titles</a></li><li class="chapter-item expanded "><a href="0547-make-the-database-timeout-configurable.html">0547 — Make the database timeout configurable</a></li><li class="chapter-item expanded "><a href="0556-keep-track-of-unmergeable-and-draft-pull-requests.html">0556 — Keep track of unmergeable and draft pull requests</a></li><li class="chapter-item expanded "><a href="0561-add-bors-cancel-as-alias-for-bors-r.html">0561 — Add &quot;bors cancel&quot; as alias for &quot;bors r-&quot;</a></li><li class="chapter-item expanded "><a href="0563-add-a-simple-health-check-endpoint.html">0563 — Add a simple health check endpoint</a></li><li class="chapter-item expanded "><a href="0566-helm-chart-and-examples-using-terraform-with-kubernetes.html">0566 — Helm chart and examples using Terraform with Kubernetes</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">The Bors RFC Archive</h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <p>The <code>required_approvals</code> option should enforce that every piece of code that makes it into the master branch, has been reviewed by the requisite number of people.  However, the current implementation counts approving reviews even if new code has been added to a PR since the review.  This unfortunate situation requires users to manually reason about which code has been adequately reviewed.  Bors should recognize approvals only if they apply to all of the changes which are going to be merged.  For backwards compatibility and flexibility, this should be controlled by a new configuration option.</p>
<blockquote>
<p>I allow this RFC document to be modified and redistributed under the terms of the <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache-2.0 license</a>, or the <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US">CC-BY-NC-SA 3.0 license</a>, at your option.</p>
</blockquote>
<h1 id="motivation"><a class="header" href="#motivation">Motivation</a></h1>
<p>Suppose you have a project which specifies <code>required_approvals = 3</code>:</p>
<ul>
<li>Person A creates a PR.</li>
<li>Reviewers B, C, and D approve it.</li>
<li>Person A pushes an &quot;extra&quot; commit to the PR.</li>
<li>Reviewer B runs <code>bors r+</code>.</li>
</ul>
<p>In this situation, bors will happily merge the PR, even though the extra commit wasn't actually approved by anyone except for possibly reviewer B.  This makes the <code>required_approvals</code> configuration option much less useful, since it fails to ensure that all changes have been approved by 3 people.</p>
<p>The invariant that <code>required_approvals = n</code> means every piece of code that makes it into the master branch has been reviewed by <em>n</em> people is a natural extension of the NRSROSE, and bors should enforce it too.</p>
<h1 id="guide-level-explanation"><a class="header" href="#guide-level-explanation">Guide-level explanation</a></h1>
<p>The configuration option <code>up_to_date_approvals = true</code> causes GitHub Reviews to count towards the number of <code>required_approvals</code> only when they are up to date.  Pushing new changes to the PR branch requires prior approving reviews to be resubmitted in order to count.</p>
<p>Enabling <code>up_to_date_approvals</code> makes certain that any code merged to master has been adequately reviewed.</p>
<h1 id="reference-level-explanation"><a class="header" href="#reference-level-explanation">Reference-level explanation</a></h1>
<p><code>up_to_date_approvals</code> is a boolean configuration option in <code>bors.toml</code> defaulting to false.</p>
<p>We say review R is <em>up to date</em> for commit hash X if R's <code>commit_id</code> key as seen through the <a href="https://developer.github.com/v3/pulls/reviews/">GitHub Review API</a> is exactly X.  Otherwise it is <em>stale</em>.  If <code>up_to_date_approvals</code> is true, then whenever the number of approving reviews is counted for the purpose of comparing against <code>required_approvals</code>, only those reviews which are up to date for the hash of the commit to be merged are counted.  If <code>up_to_date_approvals</code> is false, then all reviews from the PR are counted (maintaining current behavior).  The <code>up_to_date_approvals</code> option has no effect if <code>required_approvals</code> is not set.  The <code>up_to_date_approvals</code> option also does not affect the determination of whether or not there are any <em>rejecting</em> reviews.</p>
<p>If a bors command is rejected due to not having enough approving reviews, then bors will include the number of reviews counted and the number of reviews required in its comment.  If <code>up_to_date_approvals</code> is true, it will also include the number of approving reviews that were not counted because they were not up to date.</p>
<p>Let <em>n</em> be the value of <code>required_approvals</code>, <em>m</em> be the number of total approvals present, and <em>l</em> be the number of up to date approvals.</p>
<p>If <code>up_to_date_approvals</code> is false, or if <em>l</em> == <em>m</em>:</p>
<blockquote>
<p>Rejected by too few approved reviews: <em>m</em> out of <em>n</em> required approvals were present</p>
</blockquote>
<p>If <code>up_to_date_approvals</code> is true and <em>l</em> != <em>m</em>:</p>
<blockquote>
<p>Rejected by too few approved reviews: <em>l</em> out of <em>n</em> required approvals were present (<em>m</em> - <em>l</em> stale reviews were not counted)</p>
</blockquote>
<h1 id="drawbacks"><a class="header" href="#drawbacks">Drawbacks</a></h1>
<ul>
<li>Adds a new configuration option, increasing complexity.</li>
<li>Might require more API calls to determine if reviews are up to date.</li>
<li>UX may be confusing since GitHub will still display the stale reviews, but bors won't count them.</li>
</ul>
<h1 id="alternatives"><a class="header" href="#alternatives">Alternatives</a></h1>
<ul>
<li>Make <code>up_to_date_approvals = true</code> the default behavior or the only behavior.
<ul>
<li>Not chosen because it would be a breaking change for current workflows</li>
<li>Not all users may want this stricter behavior, since it requires more effort from reviewers and change authors</li>
</ul>
</li>
<li>Use a CI check to enforce the number of up-to-date reviews
<ul>
<li>It's more impactful to make this change in bors instead of requiring every project that wants this behavior to implement it themselves.</li>
<li>Requires duplicating most of the existing functionality of <code>required_approvals</code> just to change one small aspect of it.</li>
</ul>
</li>
<li>Do nothing
<ul>
<li>For some projects it's not acceptable for code changes to be merged without a certain minimum number of reviews.</li>
</ul>
</li>
</ul>
<h1 id="prior-art"><a class="header" href="#prior-art">Prior art</a></h1>
<ul>
<li>The GitHub option, &quot;Dismiss stale pull request approvals when new commits are pushed.&quot;, essentially implements the same behavior as this.
<ul>
<li>Note that projects using bors can't take advantage of this, because GitHub doesn't allow enabling this option without also enabling the &quot;Require [nonzero number] of approving reviews&quot; protection rule on the target branch.  This latter rule is itself <a href="https://bors.tech/documentation/getting-started/#if-it-doesnt-work">incompatible with bors</a>, since the merge commit created by bors counts as &quot;unapproved&quot;.</li>
</ul>
</li>
<li>The Gerrit approval system automatically dismisses reviews when new code is pushed.</li>
<li>graydon/bors' <a href="https://github.com/graydon/bors/blob/a6b07e6a876a312997eb241805bccb1b7899be95/bors.py#L321-L341">implementation of code review</a> uses approval comments which are either attached to the commits themselves, or with the commit hash included in the comment.  Either way, approvals only count for a single commit.  This is the implementation used by the Rust language project.</li>
</ul>
<h1 id="unresolved-questions"><a class="header" href="#unresolved-questions">Unresolved questions</a></h1>
<ul>
<li>What parts of the design do you expect to resolve through the RFC process before this gets accepted?
<ul>
<li>Final choice of configuration option name and exact wording of error messages</li>
</ul>
</li>
<li>What parts of the design do you expect to resolve through the implementation of this feature before deployment?
<ul>
<li>Details of interaction with the GitHub API to determine which reviews are stale.</li>
</ul>
</li>
<li>What related issues do you consider out of scope for this RFC that could be addressed in the future independently of the solution that comes out of this RFC?
<ul>
<li>Dismissal of stale rejecting reviews</li>
</ul>
</li>
</ul>
<h1 id="future-possibilities"><a class="header" href="#future-possibilities">Future possibilities</a></h1>
<p>Didn't think of anything.</p>
<h1 id="implementation-status"><a class="header" href="#implementation-status">Implementation status</a></h1>
<p><strong>Implemented</strong>:</p>
<ul>
<li>Pull request: https://github.com/bors-ng/bors-ng/pull/986</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="0425-allow-patches-to-be-batched-by-themselves-only.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="0507-update-base-branch-of-prs-depending-on-a-branch-that-will-be-deleted.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="0425-allow-patches-to-be-batched-by-themselves-only.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="0507-update-base-branch-of-prs-depending-on-a-branch-that-will-be-deleted.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
